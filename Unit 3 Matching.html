<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Unit 3 — Matching (Three-Column Drag & Drop)</title>
<style>
  :root{
    --bg:#0b1220; --panel:#101a2c; --ink:#e6edf3; --muted:#9fb0c6; --accent:#4fd1c5;
    --ok:#22c55e; --bad:#ef4444; --tile:#0f2034; --tile-border:rgba(255,255,255,.12);
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; color:var(--ink); background:radial-gradient(1100px 700px at 20% -10%, #13233d 0%, var(--bg) 60%);} 
  .wrap{max-width:1100px; margin:0 auto; padding:24px}
  h1{margin:0 0 6px; font-size:clamp(22px,3vw,32px)}
  p,label{color:var(--muted)}
  .card{background:var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:16px; padding:18px; box-shadow:0 6px 18px rgba(0,0,0,.25)}
  .grid{display:grid; gap:12px}
  .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  select,button{appearance:none; border:1px solid rgba(255,255,255,.12); background:#0f2034; color:var(--ink); padding:10px 12px; border-radius:12px; font-size:16px}
  button{cursor:pointer; background:linear-gradient(135deg,#1f3a5b,#17314f); border:1px solid rgba(79,209,197,.45)}
  button:hover{filter:brightness(1.08)}
  .hidden{display:none}
  .pill{display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background:#10243a; color:#a7c6ff; font-size:12px}
  .hud{display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap}
  .sep{height:1px; background:rgba(255,255,255,.08); margin:12px 0}

  /* Three-column layout */
  .columns{display:grid; grid-template-columns:1fr 1fr 1fr; gap:14px}
  @media (max-width:980px){ .columns{grid-template-columns:1fr} }

  .col-title{font-size:12px; letter-spacing:.04em; text-transform:uppercase; color:#a7c6ff; margin-bottom:8px}
  .left, .center, .right{display:grid; gap:10px}
  .prompt, .slot, .answer{border:1px solid var(--tile-border); background:var(--tile); border-radius:12px; padding:12px; min-height:64px; display:flex; gap:10px; align-items:center}
  .prompt{position:relative}
  .slot{justify-content:space-between}
  .slot.empty{opacity:.7}
  .placeholder{font-style:italic; color:var(--muted)}
  .num{flex:0 0 auto; width:28px; height:28px; border-radius:50%; background:#112a46; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:14px; border:1px solid rgba(255,255,255,.12)}
  .text{flex:1 1 auto; font-size:clamp(15px,2vw,17px); line-height:1.35}
  .ghost{opacity:.6}
  .drag-over{outline:2px dashed var(--accent)}
  .badge{font-size:12px; color:#a7c6ff}
  .correct{background:#0e2b22; border-color:#1f8a67}
  .wrong{background:#3a0f16; border-color:#ff6b6b}
  .answer{cursor:grab}
  .answer:active{cursor:grabbing}
  /* Equal heights across columns */
  .sameHeight{height:var(--rowH,auto)}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Matching — Unit 3 (Ch. 12–16)</h1>
    <p class="muted">Drag from <strong>Unused Answers</strong> (right) into the <strong>Answer Slots</strong> (center). You can also drag a placed answer to a different slot or back to Unused. Finish to review only missed items, then optionally retry just those.</p>

    <!-- START -->
    <section id="start" class="card grid">
      <div class="grid grid-2">
        <div>
          <label for="section">Set</label>
          <select id="section">
            <option value="ch12">Ch. 12 (all)</option>
            <option value="ch13">Ch. 13 (all)</option>
            <option value="ch15">Ch. 15 (all)</option>
            <option value="ch16">Ch. 16 (all)</option>
            <option value="unit3" selected>Unit 3 (random 20)</option>
          </select>
        </div>
        <div>
          <label for="size">Items</label>
          <select id="size">
            <option value="auto" selected>Auto</option>
            <option value="6">6</option>
            <option value="10">10</option>
            <option value="14">14</option>
            <option value="20">20</option>
          </select>
        </div>
      </div>
      <div class="hud">
        <div class="pill">Fill the center column by dragging answers from the right</div>
        <button id="begin">Start Round</button>
      </div>
    </section>

    <!-- QUIZ -->
    <section id="quiz" class="card hidden">
      <div class="hud">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
          <span class="pill" id="setTag">Set</span>
          <span class="pill" id="progress">Filled 0 / 0</span>
        </div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
          <span class="pill" id="timer">00:00</span>
          <span class="pill" id="best">Best: —</span>
          <button id="finish">Finish & Review</button>
        </div>
      </div>
      <div class="sep"></div>

      <div class="columns">
        <div>
          <div class="col-title">Prompts</div>
          <div class="left" id="left"></div>
        </div>
        <div>
          <div class="col-title">Answer Slots</div>
          <div class="center" id="center"></div>
        </div>
        <div>
          <div class="col-title">Unused Answers</div>
          <div class="right" id="right"></div>
        </div>
      </div>
    </section>

    <!-- RESULT -->
    <section id="result" class="card hidden">
      <h2 style="margin:0 0 6px">Round Complete</h2>
      <div class="hud" style="margin-bottom:6px">
        <span class="pill" id="scoreline">Score</span>
        <span class="pill" id="timeline">Time</span>
        <span class="pill" id="bestline">Best</span>
      </div>
      <div class="sep"></div>
      <div id="review"></div>
      <div class="hud">
        <button id="retry">New Round</button>
        <button id="retryMissed">Retry Missed Only</button>
        <button id="restart">Back to Start</button>
      </div>
    </section>
  </div>

<script>
// ---------- Helpers ----------
function shuffle(a){ const r=[...a]; for(let i=r.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [r[i],r[j]]=[r[j],r[i]]; } return r; }
function fmtTime(s){ const m=Math.floor(s/60).toString().padStart(2,'0'); const ss=(s%60).toString().padStart(2,'0'); return `${m}:${ss}`; }
function setBest(key, seconds){ const prev = Number(localStorage.getItem(key)||Infinity); if(seconds < prev){ localStorage.setItem(key, String(seconds)); } }
function getBest(key){ const v = localStorage.getItem(key); return v? fmtTime(Number(v)) : '—'; }

// ---------- Question Bank ----------
const BANK = [
  // ===== Ch. 12 (8) =====
  {chapter:12,set:'ch12',q:'What are the constitutional requirements to be president?',choices:['At least 35 years old, natural-born U.S. citizen, and resident for at least 14 years','Hold a title of nobility','Be a state resident for 20 years','Have prior military service'],answer:0},
  {chapter:12,set:'ch12',q:'What is the Whig theory of the presidency?',choices:['A 19th-century “weak presidency” view: mainly execute Congress’s will, not lead policy','A view that presidents must dominate Congress','A theory that courts set national policy','A theory of party realignment'],answer:0},
  {chapter:12,set:'ch12',q:'What is the “invisible primary”?',choices:['Pre-vote phase of fundraising, polling, and debates to prove viability','A secret internal party vote','The Electoral College meeting','The first primary in New Hampshire'],answer:0},
  {chapter:12,set:'ch12',q:'What is the Electoral College “unit rule”?',choices:['Most states award all electoral votes to the statewide popular-vote winner','Proportional allocation of electors by vote share','A House committee rule','Winner-take-one-district plan'],answer:0},
  {chapter:12,set:'ch12',q:'How many electoral votes are required to win the presidency?',choices:['270','269','300','538'],answer:0},
  {chapter:12,set:'ch12',q:'What is the Cabinet?',choices:['Heads of the 15 executive departments, appointed by the president and confirmed by the Senate','Supreme Court justices','Congressional committee chairs','State governors'],answer:0},
  {chapter:12,set:'ch12',q:'What is a parliamentary system?',choices:['System in which the prime minister leads the cabinet and usually commands a legislative majority','The U.S. presidential system','A confederation of states','Direct democracy only'],answer:0},
  {chapter:12,set:'ch12',q:'Who is Richard Neustadt in presidency studies?',choices:['Scholar who argued presidential power is the power to persuade','A Supreme Court justice','A Speaker of the House','A cabinet secretary'],answer:0},

  // ===== Ch. 13 (14) =====
  {chapter:13,set:'ch13',q:'What is a bureaucracy?',choices:['An organization with hierarchical authority, job specialization, and formalized rules','A two-chamber legislature','A federal court network','A party apparatus'],answer:0},
  {chapter:13,set:'ch13',q:'The Deepwater Horizon was…',choices:['A BP offshore platform that exploded in 2010, causing a massive Gulf oil spill','A Supreme Court case on environmental law','A hurricane in 2005','A trade agreement'],answer:0},
  {chapter:13,set:'ch13',q:'What is a government corporation?',choices:['An agency run like a business that charges for services and may receive federal funds (e.g., Amtrak)','A private nonprofit','A cabinet department','A congressional caucus'],answer:0},
  {chapter:13,set:'ch13',q:'What are regulatory agencies?',choices:['Agencies that issue rules and enforce compliance for specific economic activities','White House staff offices','Independent counsels','State legislatures'],answer:0},
  {chapter:13,set:'ch13',q:'What are independent agencies?',choices:['Agencies resembling cabinet departments but with narrower missions (e.g., CIA, NASA)','Cabinet departments','State commissions','Federal courts of appeal'],answer:0},
  {chapter:13,set:'ch13',q:'What are presidential commissions?',choices:['Advisory bodies to the president; some are permanent','Standing committees of Congress','Party national committees','State constitutional conventions'],answer:0},
  {chapter:13,set:'ch13',q:'What is the merit system?',choices:['Hiring and promotion based on exams or specialized training','Seniority in Congress','Presidential patronage','Drawing election districts'],answer:0},
  {chapter:13,set:'ch13',q:'What is the spoils system?',choices:['The practice of awarding government offices/jobs to political supporters','Civil service testing','Administrative law','Judicial review'],answer:0},
  {chapter:13,set:'ch13',q:'What is patronage?',choices:['Filling offices/jobs with supporters of the winning party','Merit-based hiring','Judicial selection by bar exam','Impeachment'],answer:0},
  {chapter:13,set:'ch13',q:'What did the Pendleton Act (1883) do?',choices:['Established a federal civil-service merit system','Created Social Security','Limited campaign donations','Established the EPA'],answer:0},
  {chapter:13,set:'ch13',q:'In the federal budget process…',choices:['The president proposes; Congress authorizes and appropriates; agencies spend under oversight','Courts set spending levels','States ratify the budget by referendum','Only the president decides final spending'],answer:0},
  {chapter:13,set:'ch13',q:'What are clientele groups?',choices:['Beneficiaries of an agency’s programs who support/defend the agency','Opponents of agencies','Foreign governments','Judges in administrative courts'],answer:0},
  {chapter:13,set:'ch13',q:'What is the GAO?',choices:['Government Accountability Office—audits spending and checks implementation of laws','Office of Management and Budget','Congressional Budget Office','Occupational Safety and Health Administration'],answer:0},
  {chapter:13,set:'ch13',q:'What is whistleblowing?',choices:['Employees reporting misconduct; protected from retaliation by law','Lobbying for agencies','Adding appropriations riders','Invoking executive privilege'],answer:0},

  // ===== Ch. 15 (12) =====
  {chapter:15,set:'ch15',q:'What is laissez-faire economics?',choices:['View that private firms should freely make production decisions; markets guided by the “invisible hand”','Demand-side stimulus policy','Communist central planning','Mercantilism'],answer:0},
  {chapter:15,set:'ch15',q:'Who was Adam Smith?',choices:['Economist who argued for laissez-faire and the “invisible hand” (1776)','Keynes’s protégé','New Deal planner','Modern Fed chair'],answer:0},
  {chapter:15,set:'ch15',q:'What is deregulation?',choices:['Rolling back rules to improve efficiency (can create risks if excessive)','Creating new rules for firms','Nationalizing industries','Raising tariffs'],answer:0},
  {chapter:15,set:'ch15',q:'Why is Rachel Carson significant?',choices:['Author of Silent Spring (1962), spurring environmental policy reforms','EPA administrator in 1970','Author of The Federalist','Supreme Court justice'],answer:0},
  {chapter:15,set:'ch15',q:'What is fiscal policy?',choices:['Government taxing and spending choices to steer the economy','Managing the money supply','Court interpretation of tax law','Targeting the monetary base'],answer:0},
  {chapter:15,set:'ch15',q:'What is monetary policy?',choices:['Managing money supply and interest rates via the Federal Reserve','Congress’s tax code','Cabinet budgeting','Court-ordered spending'],answer:0},
  {chapter:15,set:'ch15',q:'Who was John Maynard Keynes?',choices:['Economist who advocated increased government spending in downturns','A leading monetarist','A classical mercantilist','A supply-side theorist only'],answer:0},
  {chapter:15,set:'ch15',q:'What is a budget deficit?',choices:['When annual federal spending exceeds revenues','The total debt held by the public','A balanced budget','A trade surplus'],answer:0},
  {chapter:15,set:'ch15',q:'What is the national debt?',choices:['Total amount the federal government owes to creditors','Annual deficit','Primary surplus','GDP growth rate'],answer:0},
  {chapter:15,set:'ch15',q:'What did the Federal Reserve Act (1913) do?',choices:['Created the Federal Reserve System and its Board of Governors','Created Social Security','Banned gold ownership','Established the SEC'],answer:0},
  {chapter:15,set:'ch15',q:'What is inflation?',choices:['A sustained rise in the general price level','Falling prices across the board','Perfect price stability','Zero price changes'],answer:0},
  {chapter:15,set:'ch15',q:'Who is Janet Yellen (in this context)?',choices:['Economist who served as Chair of the Federal Reserve (2014–2018)','Current Chief Justice of the U.S.','Secretary of State','Chair of the SEC'],answer:0},

  // ===== Ch. 16 (8) =====
  {chapter:16,set:'ch16',q:'What is a progressive tax?',choices:['A tax with higher marginal rates as income rises','A flat tax','A sales tax only','A head tax'],answer:0},
  {chapter:16,set:'ch16',q:'What is a regressive tax?',choices:['A tax that takes a larger share from low-income than high-income payers','Steeper rates as income rises','A proportional tax','An estate tax only'],answer:0},
  {chapter:16,set:'ch16',q:'What is the poverty line?',choices:['Official threshold for poverty (historically: thrifty food budget × 3)','The median income','The unemployment rate','GDP per capita'],answer:0},
  {chapter:16,set:'ch16',q:'What was AFDC?',choices:['Aid to Families with Dependent Children; cash assistance replaced by TANF in 1996','Medicare for seniors','Social Security retirement','NATO treaty'],answer:0},
  {chapter:16,set:'ch16',q:'What is a means test?',choices:['An eligibility test requiring proof of low income/resources','Universal eligibility','Random selection','Self-attestation only'],answer:0},
  {chapter:16,set:'ch16',q:'What is an entitlement program?',choices:['A program that legally guarantees benefits to eligible individuals (e.g., Social Security, Medicare)','A discretionary grant','A one-time appropriation','A private charity'],answer:0},
  {chapter:16,set:'ch16',q:'What is Medicare?',choices:['Social insurance—health coverage for retirees—funded by payroll taxes','Medicaid expansion','CHIP only','Private exchange plan only'],answer:0},
  {chapter:16,set:'ch16',q:'What is Medicaid?',choices:['Public assistance—government-paid health insurance—for low-income people','Medicare for retirees','Social Security Disability','Private employer insurance'],answer:0},

  // ===== Ch. 17 (10) =====
  {chapter:17, set:'ch17',
   q:'What is the primary mission of the Department of Homeland Security (DHS)?',
   choices:[
    'Coordinate domestic security by preventing and responding to terrorism and major hazards within the U.S.',
    'Conduct foreign intelligence operations abroad',
    'Set and enforce monetary policy for the U.S. economy',
    'Adjudicate federal crimes through the court system'
   ],
   answer:0
  },

  {chapter:17, set:'ch17',
   q:'Which best describes a key shift in U.S. foreign policy after 9/11?',
   choices:[
    'Greater emphasis on counterterrorism and preemptive action, alongside the creation of DHS',
    'A return to strict isolationism and reduced global engagement',
    'Exclusive reliance on soft power and multilateral treaties',
    'Large-scale demobilization of the U.S. military and intelligence community'
   ],
   answer:0
  },

  {chapter:17,set:'ch17',q:'What is soft power?',choices:['Influence via culture, diplomacy, aid, and persuasion rather than military force','Naval blockade','Air strikes','Troop surge'],answer:0},
  {chapter:17,set:'ch17',q:'What are tariffs?',choices:['Taxes on imports used to raise revenue or protect domestic industries','Export subsidies only','Interest-rate caps','Immigration quotas'],answer:0},
  {chapter:17,set:'ch17',q:'What is isolationism?',choices:['Non-involvement in international alliances and conflicts','Collective security','Alliance leadership','Forward deployment'],answer:0},
  {chapter:17,set:'ch17',q:'What is the preemptive war doctrine?',choices:['Striking a potential adversary first when an attack is believed imminent','Deterrence only','Appeasement','Containment only'],answer:0},
  {chapter:17,set:'ch17',q:'A bipolar world structure refers to…',choices:['An international system dominated by two superpowers','A multipolar system','A unipolar world','A purely non-aligned world'],answer:0},
  {chapter:17,set:'ch17',q:'What was the Cold War?',choices:['Period of geopolitical tension (c. 1947–1991) between the U.S.-led West and the Soviet bloc','World War II','Only the Korean War','Only the Vietnam War'],answer:0},
  {chapter:17,set:'ch17',q:'What was containment?',choices:['U.S. strategy to prevent the spread of Soviet influence/communism','Appeasement of adversaries','Rollback of democracy','Economic autarky'],answer:0},
  {chapter:17,set:'ch17',q:'What is MAD (Mutually Assured Destruction)?',choices:['Nuclear deterrence concept where each side can inflict unacceptable damage','Massive arms reductions','A mutual defense treaty','Minimum credible deterrence'],answer:0}
];

const SETS = {
  ch12: BANK.filter(x=>x.set==='ch12'),
  ch13: BANK.filter(x=>x.set==='ch13'),
  ch15: BANK.filter(x=>x.set==='ch15'),
  ch16: BANK.filter(x=>x.set==='ch16'),
  ch17: BANK.filter(x=>x.set==='ch17'),
  unit3: [
    ...BANK.filter(x => x.set === 'ch12'),
    ...BANK.filter(x => x.set === 'ch13'),
    ...BANK.filter(x => x.set === 'ch15'),
    ...BANK.filter(x => x.set === 'ch16')
  ]
};

const SET_LABELS = { ch12:'Ch. 12', ch13:'Ch. 13', ch15:'Ch. 15', ch16:'Ch. 16', ch17:'Ch. 17', unit3:'Unit 3 (random 20)' };

// ---------- State ----------
let state = { pairs:[], left:[], right:[], center:[], timer:null, seconds:0, setKey:'unit3', missedOnly:false, misses:[] };
function bestKey(){ return `best_match_3col_${state.setKey}`; }
function startTimer(){ if(state.timer) clearInterval(state.timer); state.timer = setInterval(()=>{ state.seconds++; document.getElementById('timer').textContent = fmtTime(state.seconds); },1000); }
function stopTimer(){ if(state.timer){ clearInterval(state.timer); state.timer=null; } }

function buildPairs(items){ return items.map((x,i)=>({ id:i, chapter:x.chapter, prompt:x.q, answer:x.choices[x.answer] })); }

function startRound(fromMissed=false){
  state.setKey = document.getElementById('section').value;
  const sizeSel = document.getElementById('size').value;
  let items = fromMissed ? state.misses.map(m=>({chapter:m.chapter, q:m.prompt, choices:[m.answer], answer:0})) : [...SETS[state.setKey]];

  // Determine size
  let size = sizeSel==='auto' ? (state.setKey==='unit3' ? 20 : items.length) : Number(sizeSel);
  if(state.setKey==='unit3'){ items = shuffle(items).slice(0, size); } else { items = items.slice(0, Math.min(size, items.length)); }

  const pairs = buildPairs(items);
  state.pairs = pairs;
  state.left = pairs.map((p,i)=>({key:i, text:p.prompt, chapter:p.chapter}));
  const answers = pairs.map((p,i)=>({key:i, text:p.answer}));
  state.right = shuffle(answers);
  state.center = new Array(pairs.length).fill(null); // empty slots
  state.missedOnly = fromMissed;
  state.misses = [];
  state.seconds = 0;

  document.getElementById('start').classList.add('hidden');
  document.getElementById('result').classList.add('hidden');
  document.getElementById('quiz').classList.remove('hidden');
  document.getElementById('setTag').textContent = SET_LABELS[state.setKey];
  document.getElementById('best').textContent = 'Best: ' + getBest(bestKey());

  renderAll();
  startTimer();
}

function renderAll(){ renderLeft(); renderCenter(); renderRight(); updateProgress(); requestAnimationFrame(equalizeHeights); }

function renderLeft(){
  const L = document.getElementById('left'); L.innerHTML='';
  state.left.forEach((item, idx)=>{
    const div = document.createElement('div'); div.className='prompt sameHeight';
    const num = document.createElement('div'); num.className='num'; num.textContent=idx+1; div.appendChild(num);
    const tx = document.createElement('div'); tx.className='text'; tx.textContent=item.text; div.appendChild(tx);
    L.appendChild(div);
  });
}

function renderCenter(){
  const C = document.getElementById('center'); C.innerHTML='';
  state.center.forEach((ans, idx)=>{
    const slot = document.createElement('div'); slot.className='slot sameHeight' + (ans? '' : ' empty');
    slot.dataset.slot = idx;
    const badge = document.createElement('div'); badge.className='num'; badge.textContent = idx+1; slot.appendChild(badge);
    const content = document.createElement('div'); content.className='text';
    if(ans){
      const inner = document.createElement('div');
      inner.className='answer sameHeight';
      inner.setAttribute('draggable','true');
      inner.dataset.key = ans.key;
      inner.dataset.origin = 'center';
      const num = document.createElement('div'); num.className='num'; num.textContent = '⇄'; inner.appendChild(num);
      const tx = document.createElement('div'); tx.className='text'; tx.textContent = ans.text; inner.appendChild(tx);
      addAnswerDragHandlers(inner);
      content.innerHTML = '';
      content.appendChild(inner);
    } else {
      content.innerHTML = `<span class="placeholder">Drop answer here</span>`;
    }
    slot.appendChild(content);
    addSlotHandlers(slot);
    C.appendChild(slot);
  });
}

function renderRight(){
  const R = document.getElementById('right'); R.innerHTML='';
  state.right.forEach((item, idx)=>{
    const div = createAnswerNode(item, 'right', idx);
    div.classList.add('sameHeight');
    R.appendChild(div);
  });
}

function createAnswerNode(item, origin, idx){
  const div = document.createElement('div');
  div.className='answer';
  div.setAttribute('draggable','true');
  div.dataset.key = item.key;
  div.dataset.origin = origin; // 'right' or 'center'
  const num = document.createElement('div'); num.className='num'; num.textContent = origin==='right' ? String.fromCharCode(65+idx) : '⇄';
  const tx = document.createElement('div'); tx.className='text'; tx.textContent = item.text;
  div.appendChild(num); div.appendChild(tx);
  addAnswerDragHandlers(div);
  return div;
}

function updateProgress(){
  const total = state.center.length;
  const filled = state.center.filter(Boolean).length;
  document.getElementById('progress').textContent = `Filled ${filled} / ${total}`;
}

// ---- Drag & Drop ----
let dragData = null; // {type:'answer', from:'right'|'center', key:number, fromIndex?:number, fromSlot?:number}

function addAnswerDragHandlers(node){
  node.addEventListener('dragstart', (e)=>{
    const key = Number(node.dataset.key);
    const origin = node.dataset.origin;
    dragData = {type:'answer', from:origin, key};
    if(origin==='right'){
      const idx = [...node.parentNode.children].indexOf(node);
      dragData.fromIndex = idx;
    } else if(origin==='center'){
      // find which slot holds this key
      const slotIndex = state.center.findIndex(a=>a && a.key===key);
      dragData.fromSlot = slotIndex;
    }
    node.classList.add('ghost');
    e.dataTransfer.effectAllowed='move';
  });
  node.addEventListener('dragend', ()=>{ node.classList.remove('ghost'); renumberRight(); requestAnimationFrame(equalizeHeights); });
}

function addSlotHandlers(slot){
  slot.addEventListener('dragover', (e)=>{ e.preventDefault(); slot.classList.add('drag-over'); });
  slot.addEventListener('dragleave', ()=> slot.classList.remove('drag-over'));
  slot.addEventListener('drop', (e)=>{
    e.preventDefault(); slot.classList.remove('drag-over');
    if(!dragData || dragData.type!=='answer') return;
    const targetSlot = Number(slot.dataset.slot);

    if(dragData.from==='right'){
      // move from right -> center slot; if occupied, swap
      const answerObj = state.right.splice(dragData.fromIndex,1)[0];
      if(state.center[targetSlot]){ // swap to right
        const displaced = state.center[targetSlot];
        state.center[targetSlot] = answerObj;
        state.right.splice(dragData.fromIndex,0,displaced); // put displaced back near original spot
      } else {
        state.center[targetSlot] = answerObj;
      }
    } else if(dragData.from==='center'){
      // move from one center slot -> another center slot (swap)
      const fromSlot = dragData.fromSlot;
      const temp = state.center[targetSlot];
      state.center[targetSlot] = state.center[fromSlot];
      state.center[fromSlot] = temp || null;
    }
    renderCenter();
    renderRight();
    updateProgress();
    requestAnimationFrame(equalizeHeights);
  });
}

// Allow dropping into Unused Answers area to return an answer from a center slot
const rightBox = document.getElementById('right');
rightBox.addEventListener('dragover', (e)=>{ e.preventDefault(); rightBox.classList.add('drag-over'); });
rightBox.addEventListener('dragleave', ()=> rightBox.classList.remove('drag-over'));
rightBox.addEventListener('drop', (e)=>{
  e.preventDefault(); rightBox.classList.remove('drag-over');
  if(!dragData || dragData.type!=='answer') return;
  if(dragData.from==='center'){
    const fromSlot = dragData.fromSlot;
    const moved = state.center[fromSlot];
    if(moved){ state.center[fromSlot] = null; state.right.push(moved); renderCenter(); renderRight(); updateProgress(); requestAnimationFrame(equalizeHeights); }
  }
});

function renumberRight(){
  // Update letter badges A, B, C... for right column
  [...document.querySelectorAll('#right .answer .num')].forEach((n,i)=>{ n.textContent = String.fromCharCode(65+i); });
}

function finish(){
  stopTimer();
  const total = state.center.length;
  let correct = 0; state.misses = [];

  // Grade based on center slots: slot i should contain answer with key i
  state.center.forEach((ans, i)=>{
    const left = state.left[i];
    const correctAnswer = state.pairs[i].answer;
    const ok = !!ans && ans.key===i;
    if(ok) correct++; else state.misses.push({chapter:left.chapter, prompt:left.text, answer: correctAnswer});
  });

  // Result UI
  document.getElementById('quiz').classList.add('hidden');
  document.getElementById('result').classList.remove('hidden');
  if(!state.missedOnly){ setBest(bestKey(), state.seconds); }

  document.getElementById('scoreline').textContent = `Score: ${correct} / ${total} (${Math.round(correct/total*100)}%)`;
  document.getElementById('timeline').textContent = `Time: ${fmtTime(state.seconds)}`;
  document.getElementById('bestline').textContent = `Best: ${getBest(bestKey())}`;

  // Build review of only misses (show chosen vs correct)
  const rev = document.getElementById('review'); rev.innerHTML='';
  if(state.misses.length===0){
    rev.innerHTML = '<p class="muted">Perfect! No missed items to review.</p>';
  } else {
    const list = document.createElement('div'); list.className='grid'; list.style.gridTemplateColumns='1fr'; list.style.gap='10px';
    state.center.forEach((ans,i)=>{
      const ok = !!ans && ans.key===i;
      if(ok) return;
      const row = document.createElement('div'); row.className='card'; row.style.padding='12px';
      row.innerHTML = `<div style="font-weight:700; margin-bottom:6px">Missed · Ch. ${state.left[i].chapter}</div>`+
                      `<div style="margin-bottom:6px">${state.left[i].text}</div>`+
                      `<div style="display:flex; gap:8px; flex-wrap:wrap">`+
                      `<span class="pill">Your answer: ${ans? ans.text : '—'}</span>`+
                      `<span class="pill">Correct: ${state.pairs[i].answer}</span>`+
                      `</div>`;
      list.appendChild(row);
    });
    rev.appendChild(list);
  }
}

function startRoundMissed(){
  if(!state.misses || state.misses.length===0){ alert('No missed items to retry.'); return; }
  startRound(true);
}

// nav
 document.getElementById('begin').addEventListener('click', ()=> startRound(false));
 document.getElementById('retry').addEventListener('click', ()=> startRound(false));
 document.getElementById('retryMissed').addEventListener('click', startRoundMissed);
 document.getElementById('restart').addEventListener('click', ()=>{
   document.getElementById('result').classList.add('hidden');
   document.getElementById('start').classList.remove('hidden');
 });
 document.getElementById('finish').addEventListener('click', finish);

// ------- Equal heights across all boxes -------
function equalizeHeights(){
  const all = [
    ...document.querySelectorAll('.left .prompt'),
    ...document.querySelectorAll('.center .slot'),
    ...document.querySelectorAll('.right .answer')
  ];
  if(!all.length) return;
  all.forEach(n=>{ n.style.height='auto'; });
  let max = 0;
  all.forEach(n=>{ max = Math.max(max, n.offsetHeight); });
  all.forEach(n=>{ n.style.height = max + 'px'; });
}

function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args), ms); }; }
window.addEventListener('resize', debounce(()=> requestAnimationFrame(equalizeHeights), 100));

// -------- Drag auto-scroll near viewport edges (helps when dragging from top to bottom) --------
(function setupAutoScroll(){
  const EDGE = 80;          // px from top/bottom that triggers scrolling
  const SPEED = 24;         // px per tick
  let ticking = false;
  document.addEventListener('dragover', (e)=>{
    // don't block default behavior globally; just nudge the window if close to edges
    const y = e.clientY;
    const h = window.innerHeight;
    let dy = 0;
    if(y < EDGE) dy = -SPEED;
    else if(h - y < EDGE) dy = SPEED;
    if(dy !== 0 && !ticking){
      ticking = true;
      window.requestAnimationFrame(()=>{ window.scrollBy(0, dy); ticking = false; });
    }
  });
})();

// -------- Small runtime self-tests (non-intrusive) --------
(function selfCheck(){
  try{
    console.assert(Array.isArray(BANK) && BANK.length >= 1, 'BANK should have items');
    console.assert(BANK.length === 52, 'BANK should contain 52 items, got ' + BANK.length);
    const bySet = ['ch12','ch13','ch15','ch16','ch17'];
    bySet.forEach(s=>{ console.assert(SETS[s].every((x,i)=>typeof x.q==='string' && x.choices && x.choices.length>0), 'Malformed item in '+s); });
    console.log('%cSelf-check passed','color:#4fd1c5');
  }catch(e){ console.warn('Self-check failed', e); }
})();
</script>
</body>
</html>
